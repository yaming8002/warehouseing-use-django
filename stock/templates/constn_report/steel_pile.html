{% extends 'base/base_table.html' %}{{ '' }}
{% block title %}{{ title }} {{ '' }}{% endblock %}
{% block javascript %}
  <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
  <script type="text/javascript"
          src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
  <script>
    $(document).ready(function () {
      // Adjusting the style of the caption in the table with id 'base_table'

      // Setting up the click event for the button with id 'exceloutput'
      $('#exceloutput').click(function() {
        var fileName = $('#base_table caption').text(); // Getting the text of the caption as file name
        $('#base_table').tableExport({
          type: 'excel',
          mso: {
            fileFormat: 'xlsx',
          },
          fileName: fileName // Using the captured file name
        });
      });


    });
    function editRow(id) {
      // 結案選單
      $.ajax({
        url: '/constn/pile/edit/',
        method: 'GET',
        data: { 'id': id },
        success: function (data) {
          $('#modalContainer').html(data)
          $('#createModal').modal('show')
        },
        error: function (error) {
          console.error('Error loading modal content: ', error)
        }
      })
    }

  </script>
{% endblock %}
{% block form %}
  {% load strmap %}
  {% load custom_filters %}
  <!-- Corrected form tag and added trailing slash to action attribute -->
  <form id="search" action="/constn/pile/" method="POST">
    {% csrf_token %}
    {% include "constn/siteinfo_select.html" %}
    <input type="submit" value="查詢" />
    <input type="button" id="exceloutput" value="匯出EXCEL" />
  </form>
{% endblock %}
{% block table %}
  <caption>{{ constn.code }}{{ constn.owner }}-{{ constn.name }}-鋼樁</caption>
  <!--{{steel_pile_table }}-->
  <tbody>
    <tr>
      <th rowspan="2">規格:</th>
      <th colspan="6" class="table-danger">出料</th>
      <th colspan="6" class="table-success">入料</th>
      <th rowspan="2">支差異</th>
      <th rowspan="2">M差異</th>
    </tr>
    <tr style="height: 20px">
      <th class="table-danger">日期</th>
      <th class="table-danger">支</th>
      <th class="table-danger">合計M</th>
      <th class="table-danger">單號</th>
      <th class="table-danger">備註</th>
      {% if request.session.u_permission > 1 %}<th class="table-danger">編輯</th>{% endif %}
      <th class="table-success">日期</th>
      <th class="table-success">支</th>
      <th class="table-success">合計M</th>
      <th class="table-success">單號</th>
      <th class="table-success">備註</th>
      {% if request.session.u_permission > 1 %}<th class="table-success">編輯</th>{% endif %}
    </tr>
    {% for key, tran_map in steel_pile_table.items %}
      {% if tran_map.max_length > 2 %}
        <tr style=" border-top: 2px solid #000;">
          <th class="s5"
              dir="ltr"
              rowspan="{{ tran_map.max_length }}"
              style="vertical-align: middle">{{ key }}</th>
        </tr>
        {% for row in tran_map.table %}
          <tr style="height: 20px">
            {% for item in row %}
              {% if item %}
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.translog.build_date | date:"Y/m/d" }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.quantity |floatformat:"0" }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.unit |floatformat:"2" }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.translog.code }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {% if item.translog.turn_site|is_not_none %}
                    {% if forloop.counter|divisibleby:2 %}
                      轉移
                    {% else %}
                      來源
                    {% endif %}
                    {{ item.translog.turn_site.code }}
                    <br>
                  {% endif %}
                  {% if item.remark|is_not_none %}{{ item.remark | linebreaksbr | safe }}{% endif %}
                </td>
                {% if request.session.u_permission > 1 %}
                  <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                    {% if item.material.mat_code != '3050' %}
                      <a class="editRow_select" href="#" onclick="editRow({{ item.id }})">編輯構台樑</a>
                    {% endif %}
                  </td>
                {% endif %}
              {% else %}
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                {% if request.session.u_permission > 1 %}
                  <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if forloop.first %}
              <th rowspan="{{ tran_map.summary.max_length }}">{{ tran_map.summary.diff_count |floatformat:"0" }}</th>
              <th rowspan="{{ tran_map.summary.max_length }}">{{ tran_map.summary.diff_unit |floatformat:"2" }}</th>
            {% endif %}
          </tr>
        {% endfor %}
        <tr style="height: 20px">
          {% for row in tran_map.level_summary %}
            <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'>總計:</th>
            <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'>
              {{ row.count |floatformat:"0" }}
            </th>
            <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'>
              {{ row.unit |floatformat:"2" }}
            </th>
            <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'></th>
            <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'></th>
            {% if request.session.u_permission > 1 %}
              <th class='{% if forloop.counter == 2 %} table-success {% else %} table-danger{% endif %}'></th>
            {% endif %}
          {% endfor %}
          {% if not tran_map.table %}
            <th rowspan="{{ tran_map.summary.max_length }}">0</th>
            <th rowspan="{{ tran_map.summary.max_length }}">0</th>
          {% endif %}
        </tr>
      {% endif %}
    {% endfor %}
    <tr>
      <td class="separator"></td>
    </tr>
    <tr class='table-warning'>
      <td colspan="15">NG 廢鐵</td>
    </tr>
    <tr>
      <th rowspan="2">規格:</th>
      <th colspan="6" class="table-danger">出料</th>
      <th colspan="8" class="table-success">入料</th>
    </tr>
    <tr style="height: 20px">
      <th class="table-danger">日期</th>
      <th class="table-danger">支</th>
      <th class="table-danger">合計M</th>
      <th class="table-danger">單號</th>
      <th colspan="2" class="table-danger">備註</th>
      <th class="table-success">日期</th>
      <th class="table-success">支</th>
      <th class="table-success">合計M</th>
      <th class="table-success">單號</th>
      <th colspan="4" class="table-success">備註</th>
    </tr>
    {% load custom_filters %}
    {% for key, tran_map in steel_ng_table.items %}
      {% if tran_map.max_length > 2 %}
        <tr>
          <th class="s5"
              dir="ltr"
              rowspan="{{ tran_map.max_length }}"
              style="vertical-align: middle">{{ key }}</th>
        </tr>
        {% for row in tran_map.table %}
          <tr style="height: 20px">
            {% for item in row %}
              {% if item %}
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.translog.build_date | date:"Y/m/d" }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>-</td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.material.mat_code|kg_to_meter:item.quantity }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
                  {{ item.translog.code }}
                </td>
                <td {% if forloop.counter == 2 %} class='table-success' colspan="4"{% else %} class='table-danger' colspan="2"{% endif %}>
                  {% if item.remark|is_not_none %}{{ item.remark | linebreaksbr | safe }}{% endif %}
                  ({{ item.quantity }}&nbsp;&nbsp;KG)
                </td>
              {% else %}
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></td>
                <td {% if forloop.counter == 2 %} class='table-success' colspan="4"{% else %} class='table-danger' colspan="2"{% endif %}>
                </td>
              {% endif %}
            {% endfor %}
          </tr>
        {% endfor %}
        <tr style="height: 20px">
          {% for row in tran_map.level_summary %}
            <th {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>總計:</th>
            <th {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>-</th>
            <th {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}>
              {{ row.unit |floatformat:"2" }}
            </th>
            <th {% if forloop.counter == 2 %} class='table-success'{% else %} class='table-danger'{% endif %}></th>
            <th {% if forloop.counter == 2 %} class='table-success' colspan="4"{% else %} class='table-danger' colspan="2"{% endif %}>
            </th>
          {% endfor %}
        </tr>
      {% endif %}
    </tbody>
  {% endfor %}
{% endblock %}
