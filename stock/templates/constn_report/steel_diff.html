{% extends 'base/base_table.html' %}{{ '' }}
{% block title %}{{ title }} {{ '' }}{% endblock %}
{% load custom_filters %}
{% block javascript %}
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script>
    function exceloutput_diff(){
      var sitecode = $('#sitelist').val() ;
      $.ajax({
        url: '/constn/constn_diff/output',
        method: 'GET',
        data: { 'sitecode': sitecode },
        xhrFields: {
          responseType: 'blob'  // Specify the response type as a blob to handle binary data
        },
        success: function (response, status, xhr) {
          // Get the filename from the response headers (if sent by the server)
          var filename =  $('#base_table caption').text().trim()+'.xlsx';
          console.log(filename)
          // Create a new Blob object using the response data
          var blob = new Blob([response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

          // Create a link element to trigger the download
          var link = document.createElement('a');
          link.href = window.URL.createObjectURL(blob);
          link.download = filename;

          // Append the link to the body
          document.body.appendChild(link);

          // Trigger the download
          link.click();

          // Remove the link from the document
          document.body.removeChild(link);
      },
      error: function (error) {
          console.error('Error downloading the Excel file:', error);
      }
      });
    }
  </script>
{% endblock %}
{% block styles %}{% endblock %}
{% block form %}
  {% load strmap %}
  <!-- Corrected form tag and added trailing slash to action attribute -->
  <form id="search" action="/constn/constn_diff/" method="POST">
    {% csrf_token %}
    {% include "constn/siteinfo_select.html" %}
    <input type="submit" value="查詢" />
    <input type="button" value="匯出EXCEL" onclick='exceloutput_diff()' />
  </form>
{% endblock %}
{% block table %}
  <caption>
    <h3>[{{ constn.code }}]{{ constn.owner }}--{{ constn.name }}-差異表</h3>
  </caption>
  <!--{{steel_pile_table }}-->
  <tbody>
    <tr>
      <th colspan="9">實作出入料狀況</th>
    </tr>
    <tr>
      <th colspan="2">倉庫材料</th>
      <th colspan="2">A.實作出料數量</th>
      <th colspan="2">B.實作收回數量</th>
      <th>C.NG鐵回收</th>
      <th colspan="2">A-B差異數</th>
    </tr>
    <tr>
      <th>品項</th>
      <th>單位</th>
      <th>支數</th>
      <th>米數</th>
      <th>支數</th>
      <th>米數</th>
      <th>米數</th>
      <th>支數</th>
      <th>米數</th>
    </tr>
    {% for steel in steel_table %}
      <tr>
        <td>{{ steel.name }}</td>
        <td>{{ steel.unit_name }}</td>
        <td>{{ steel.input.quantity |floatformat:"2" }}</td>
        <td>{{ steel.input.unit |floatformat:"2" }}</td>
        <td>{{ steel.output.quantity |floatformat:"2" }}</td>
        <td>{{ steel.output.unit |floatformat:"2" }}</td>
        <td>{{ steel.ng_value |floatformat:"2" }}</td>
        <td>{{ steel.input.quantity|subtract:steel.output.quantity |floatformat:"2" }}</td>
        <td>{{ steel.input.unit|subtract:steel.output.unit |floatformat:"2" }}</td>
      </tr>
    {% endfor %}
    <tr>
      <th colspan="2">倉庫材料</th>
      <th colspan="2">A.實作出料數量</th>
      <th colspan="2">B.實作收回數量</th>
      <th colspan="3">A-B差異數</th>
    </tr>
    <tr>
      <th>品項</th>
      <th>單位</th>
      <th>數量</th>
      <th>備註</th>
      <th>數量</th>
      <th>備註</th>
      <th>數量</th>
      <th colspan=2>備註</th>
    </tr>
    {% for item in components %}
      <tr>
        <td>{{ item.name }}</td>
        <td>{{ item.unit_name }}</td>
        <td>
          {% if item.mat_id == '102' %}
            {{ item.input.quantity |floatformat:"2" }}
          {% else %}
            {{ item.input.quantity |floatformat:"0" }}
          {% endif %}
        </td>
        <td></td>
        <td>
          {% if item.mat_id == '102' %}
            {{ item.output.quantity |floatformat:"2" }}
          {% else %}
            {{ item.output.quantity |floatformat:"0" }}
          {% endif %}
        </td>
        <td></td>
        <td>
          {% if item.mat_id == '102' %}
            {{ item.input.quantity|subtract:item.output.quantity |floatformat:"2" }}
          {% else %}
            {{ item.input.quantity|subtract:item.output.quantity |floatformat:"0" }}
          {% endif %}
        </td>
        <td colspan=2></td>
      </tr>
    {% endfor %}
  {% endblock %}
