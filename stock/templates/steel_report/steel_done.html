{% extends 'base/base_table.html' %}{{ '' }}
{% block title %}{{ title }} {{ '' }}{% endblock %}
{% block javascript %}
  <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
  <script type="text/javascript"
          src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
  <script>
    $(document).ready(function () {
      // Adjusting the style of the caption in the table with id 'base_table'
      $("#base_table caption").each(function () {
        $(this).css({
          "position": "static",
          "left": "auto",
          "width": "auto",
          "height": "auto",
          "overflow": "visible",
          "clip": "auto",
          "caption-side": "top"
        });
      });


    });

    function editRow(id) {
      // 結案選單
      $.ajax({
        url: '/steel_done/edit/',
        method: 'GET',
        data: { 'id': id },
        success: function (data) {
          $('#modalContainer').html(data)
          $('#createModal').modal('show')
        },
        error: function (error) {
          console.error('Error loading modal content: ', error)
        }
      })
    }

    function rollback(id) {
      // 退回
      if (confirm("您确定要退回此信息吗？")) {
        $.ajax({
            url: '/steel_done/withdraw/',
            method: 'GET',
            data: { 'id': id },
            success: function(data) {
              alert('已取消結案') ;
              $('#search').submit() ;
            },
            error: function(error) {
                console.error('Error loading modal content: ', error);
            }
        });
      }

    }
  </script>
{% endblock %}
{% block styles %}
  <style>
  .tableStyle table{
    table-layout: auto;
    min-width: auto !important;  /* 可以根据需要调整 */
    min-height: auto !important;
    width: auto;      /* 允许表格根据内容自动调整宽度 */
  }


  </style>
{% endblock %}
{% block form %}
  <form id="search" action="/steel_done/" method="GET">
    {% csrf_token %}
    <p>
      <label for="yearMonthInput">選擇年月:</label>
      <input type="month"
             id="yearMonthInput"
             name="yearMonth"
             value='{{ yearMonth }}'>
    </p>
    <input type="submit" value="查詢" />
    <!-- <input type="button" id="exceloutput" value="匯出EXCEL" />-->
  </form>
{% endblock %}
{% block table %}
  <caption>
    <h3>月份:{{ yearMonth }}</h3>
  </caption>
  <tr>
    <th>工地代號</th>
    <th>業主</th>
    <th>名稱</th>
    <th>
      H300
      <br>
      支撐(m)
    </th>
    <th>
      H300
      <br>
      中柱(m)
    </th>
    <th>
      H350
      <br>
      支撐(m)
    </th>
    <th>
      H350
      <br>
      中柱(m)
    </th>
    <th>
      H400
      <br>
      支撐(m)
    </th>
    <th>
      H400
      <br>
      中柱(m)
    </th>
    <th>
      H408
      <br>
      支撐(m)
    </th>
    <th>
      H414
      <br>
      支撐(m)
    </th>
    <th>
      H414
      <br>
      中柱(m)
    </th>
    <th>覆工板(片)</th>
    <th>千斤頂(個)</th>
    <th>土壓計(個)</th>
    <th colspan='6' rowspan='2'>差       異      數      說       明</th>
    {% if request.session.u_permission > 1 %}<th rowspan='2'>編輯</th>{% endif %}
  </tr>
  <tr>
    <th colspan='3'>上期之總計({{ before_yearMonth }})</th>
    <th>{{ befote_total_report.m_358 }}</th>
    <th>{{ befote_total_report.m_352 }}</th>
    <th>{{ befote_total_report.m_295 }}</th>
    <th>{{ befote_total_report.m_400 }}</th>
    <th>{{ befote_total_report.m_424 }}</th>
    <th>{{ befote_total_report.m_367 }}</th>
    <th>{{ befote_total_report.m_170 }}</th>
    <th>{{ befote_total_report.m_193 }}</th>
    <th>{{ befote_total_report.m_265 }}</th>
    <th>{{ befote_total_report.m_102 }}</th>
    <th>{{ befote_total_report.m_18 |floatformat:"0" }}</th>
    <th>{{ befote_total_report.m_19 |floatformat:"0" }}</th>
  </tr>
  {% load strmap %}
  {% load custom_filters %}
  {% define 0 as encountered_done_type %}
  {% for item in list %}
    {% if item.done_type|check_done_type:encountered_done_type %}
      {% define item.done_type as encountered_done_type %}
      <tr>
        <th colspan='22' class="table-warning">{% get_done_type_value encountered_done_type %}</th>
      </tr>
    {% endif %}
    <tr>
      <td>{{ item.siteinfo.code }}</td>
      <td>{{ item.siteinfo.owner }}</td>
      <td>
        {% if item.siteinfo.name %}{{ item.siteinfo.name }}{% endif %}
      </td>
      <td>
        {% if item.m_358 != 0 %}{{ item.m_358 }}{% endif %}
      </td>
      <td>
        {% if item.m_352 != 0 %}{{ item.m_352 }}{% endif %}
      </td>
      <td>
        {% if item.m_295 != 0 %}{{ item.m_295 }}{% endif %}
      </td>
      <td>
        {% if item.m_400 != 0 %}{{ item.m_400 }}{% endif %}
      </td>
      <td>
        {% if item.m_424 != 0 %}{{ item.m_424 }}{% endif %}
      </td>
      <td>
        {% if item.m_367 != 0 %}{{ item.m_367 }}{% endif %}
      </td>
      <td>
        {% if item.m_170 != 0 %}{{ item.m_170 }}{% endif %}
      </td>
      <td>
        {% if item.m_193 != 0 %}{{ item.m_193 }}{% endif %}
      </td>
      <td>
        {% if item.m_265 != 0 %}{{ item.m_265 }}{% endif %}
      </td>
      <td>
        {% if item.m_102 != 0 %}{{ item.m_102 }}{% endif %}
      </td>
      <td>
        {% if item.m_18 != 0 %}{{ item.m_18 |floatformat:"0" }}{% endif %}
      </td>
      <td>
        {% if item.m_19 != 0 %}{{ item.m_19 |floatformat:"0" }}{% endif %}
      </td>
      <td colspan='6' style="text-align:left">
        {% if item.remark %}
          {{ item.remark |safe }}
          <br>
        {% endif %}
        {% if item.turn_site_id %}目的地:[{{ item.turn_site.code }}]{{ item.turn_site.owner }}{% endif %}
      </td>
      {% if request.session.u_permission > 1 %}
        <td>
          <a class="editRow_select" href="#" onclick="editRow({{ item.id }})">編輯</a>
          {% if item.done_type > 2 %}<a href="#" onclick="rollback({{ item.id }})">退回</a>{% endif %}
        </td>
      {% endif %}
    </tr>
  {% endfor %}
  <tr>
    <th colspan='3'>總計</th>
    <th>{{ sum_report.m_358 }}</th>
    <th>{{ sum_report.m_352 }}</th>
    <th>{{ sum_report.m_295 }}</th>
    <th>{{ sum_report.m_400 }}</th>
    <th>{{ sum_report.m_424 }}</th>
    <th>{{ sum_report.m_367 }}</th>
    <th>{{ sum_report.m_170 }}</th>
    <th>{{ sum_report.m_193 }}</th>
    <th>{{ sum_report.m_265 }}</th>
    <th>{{ sum_report.m_102 }}</th>
    <th>{{ sum_report.m_18 |floatformat:"0" }}</th>
    <th>{{ sum_report.m_19 |floatformat:"0" }}</th>
    <th colspan='6'></th>
    {% if request.session.u_permission > 1 %}<th></th>{% endif %}
  </tr>
  <tr class="table-warning">
    <th colspan='3'>總計({{ yearMonth }})</th>
    <th>{{ total_report.m_358 }}</th>
    <th>{{ total_report.m_352 }}</th>
    <th>{{ total_report.m_295 }}</th>
    <th>{{ total_report.m_400 }}</th>
    <th>{{ total_report.m_424 }}</th>
    <th>{{ total_report.m_367 }}</th>
    <th>{{ total_report.m_170 }}</th>
    <th>{{ total_report.m_193 }}</th>
    <th>{{ total_report.m_265 }}</th>
    <th>{{ total_report.m_102 }}</th>
    <th>{{ total_report.m_18 |floatformat:"0" }}</th>
    <th>{{ total_report.m_19 |floatformat:"0" }}</th>
    <th colspan='6'></th>
    {% if request.session.u_permission > 1 %}<th></th>{% endif %}
  </tr>
  <tr class="table-warning">
    <th colspan=3>差異數)</th>
    {% for d in diff %}
      <th>
        {% if forloop.counter < 11 %}
          {{ d }}
        {% else %}
          {{ d|floatformat:"0" }}
        {% endif %}
      </th>
    {% endfor %}
    <th colspan='6'></th>
    {% if request.session.u_permission > 1 %}<th></th>{% endif %}
  </tr>
{% endblock %}
