{% extends 'base/base_table.html' %}
{% block javascript %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script type="text/javascript">
    var columns3 = {{ columns3 | safe }};
    var columns4 = {{ columns4 | safe }};
    var end_date={{ end_date }};
    var url = "{{ action }}";
  $(document).ready(function() {
      // 綁定保存按鈕的點擊事件
      $('#upload_button').on('click', function(event) {
          event.preventDefault();
          var fileInput = document.getElementById('excelFile');
          var file = fileInput.files[0];
          if (file) {
              // 顯示載入指示器
              $("#base_table tbody").empty();
              showSpinner();
              handleFileProcessing(file);
          } else {
              // 如果沒有選擇檔，則提示用戶
              alert("請先選擇一個檔。");
          }
      });
  });
  
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // 判斷這個cookie的名稱是否等於所查找的名稱
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  
  function checkColumns(columns, input) {
      const cleanedColumns = columns.filter(item => item !== null && item.trim() !== "").map(item => item.replace(/\s+/g, ''));
      return columns.length === cleanedColumns.length && columns.every((col, index) => col === cleanedColumns[index]);
  }
  
  async function handleFileProcessing(file) {
      const reader = new FileReader();
      reader.onload = async function(e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, {
              type: 'binary'
          });
  
          const worksheet = workbook.Sheets["總表"];
          // 轉換工作表資料為JSON
          const total_rows = XLSX.utils.sheet_to_json(workbook.Sheets["總表"], {
              header: 1
          });
          const rent_rows = XLSX.utils.sheet_to_json(workbook.Sheets["租賃"], {
              header: 1
          });
          if (total_rows.length > 0 || rent_rows.length > 1) {
              // 驗證列名
              if (checkColumns(columns3, total_rows[2]) & checkColumns(columns4, total_rows[3])) {
                  // 如果驗證通過，則處理並分批上傳資料
                await processAndUploadData(total_rows.slice(4), false); // 移除列名行
              } else {
                  alert("總表檔案格式不正確");
              }
  
              if (checkColumns(columns3, rent_rows[2]) & checkColumns(columns4, rent_rows[3])) {
                await processAndUploadData(rent_rows.slice(4), true); // 移除列名行
              } else {
                  alert("租賃檔案格式不正確");
              }
          }
  
      };
      await reader.readAsBinaryString(file);
  }
  
  // 處理並分批上傳資料
  async function processAndUploadData(rows, is_rent) {
    const csrftoken = getCookie('csrftoken');
    const batchSize = 50;
    let batchData = [];

    for (let i = 0; i < rows.length; i++) {
        console.info("上传中..." + i + "/" + rows.length);
        if (end_date < rows[i][1]) {
            batchData.push(rows[i]);
        }

        // Upload when batch is full or at the end of array
        if (batchData.length === batchSize || rows[i].length < 2 || !rows[i][6]) {
          $('#update_text').text("上传中..." + i + "/" + rows.length);
            try {
                await $.ajax({
                    url: url,
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    headers: {'X-CSRFToken': csrftoken},
                    data: JSON.stringify({ jsonData: batchData, is_rent: is_rent }),
                    dataType: 'json',
                    success:function(data ){
                      data.error_list.forEach(item => {
                        const tr = $('<tr></tr>').append(`<td>${item.e}</td>`);
                        item.item.slice(1).forEach(col => {
                            tr.append(`<td>${col || ''}</td>`);
                        });
                        $("#base_table tbody").append(tr);
                    });
                    }
                });

            } catch (error) {
                console.error("上传数据过程中出现错误：", error);
            }
            batchData = []; // Clear the batch data after upload
            if (rows[i].length < 2 || !rows[i][6]) {
              break; // Skip the rest if data is incomplete
          }
        }
    }

    // Update the end date if applicable
    if (is_rent) {
        try {
            await $.ajax({
                url: "/update_end_date/",
                method: 'GET'
            });
            alert("上传完成");
            hideSpinner();
        } catch (error) {
            console.error("更新结束日期过程中出现错误：", error);
        }
    }
}

  </script>
{% endblock %}
{% block form %}
  <h2>{{ titles }}上傳EXCEL檔案</h2>
  <!-- 修改了 form 的 id 以便直接選中 -->
  <form id="upload_excel_form"
        method="post"
        action="/transport_log/uploadexcel/"
        enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" id="excelFile" name="excel_file" accept=".xlsx" />
    <!-- 修改了按鈕的 ID 以防止與 form 的 ID 混淆 -->
    <button type="button" id="upload_button">上傳</button>
  </form>
{% endblock %}
{% block table %}
  <caption>匯入異常</caption>
  <thead>
    <tr>
      <th rowspan="2">異常</th>
      <th rowspan="2">日期</th>
      <th colspan="4">工 地</th>
      <th colspan="5">材料規格</th>
      <th colspan="6">倉庫</th>
      <th colspan="3">月報表</th>
      <th rowspan="2">備註</th>
      <th colspan="2">施工層別</th>
      <th colspan="2">吊卡車公司</th>
      <th colspan="2">經手人</th>
      <th rowspan="2">key單日期</th>
    </tr>
    <tr>
      <th>工地編號</th>
      <th>轉單工地</th>
      <th>業主</th>
      <th>工地名稱</th>
      <th>單據編號</th>
      <th>產品編號</th>
      <th>品名</th>
      <th>單位(米)</th>
      <th>米數規格</th>
      <th>入庫量</th>
      <th>出庫量</th>
      <th>入庫米數</th>
      <th>出庫米數</th>
      <th>入出庫淨額</th>
      <th>總米數淨額</th>
      <th>入料</th>
      <th>出料</th>
      <th>數量</th>
      <th>層碼</th>
      <th>層數</th>
      <th>公司</th>
      <th>車號</th>
      <th>編號</th>
      <th>姓名</th>
    </tr>
  </thead>
  <tbody>
    {% for x in error_list %}
      <tr>
        <td>{{ x.e }}</td>
        {% for item in x.item %}<td>{{ item }}</td>{% endfor %}
      </tr>
    {% endfor %}
  </tbody>
{% endblock %}
